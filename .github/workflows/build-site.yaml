on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

name: Build site

jobs:
  build:
    name: Build site
    id: build
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install cURL Headers
        run: |
          sudo apt-get update
          sudo apt-get install libcurl4-openssl-dev

      - name: Get Hugo version
        id: hugo_vr
        run: |
          ver=$(cat .Rprofile | grep hugo.version | cut -d'"' -f2 )
          echo ".Rprofile sets hugo version to $ver"
          echo "hugo_v=${ver}" >> $GITHUB_ENV

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: ${{ env.hugo_v }}
          extended: true

      - name: Build
        run: |
          if [[ '${{github.ref}}' == 'refs/heads/main' ]]; then
            hugo -e production
          else
            hugo -b https://${{ github.head_ref }}--drmowinckels.netlify.app/
          fi

      - name: Deploy production ğŸš€
        if: github.ref == 'refs/heads/main'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: public

      - name: Deploy to Netlify
        if: github.event_name == 'pull_request'
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
            npm install netlify-cli -g
            netlify deploy --alias ${{ github.head_ref }}
        shell: sh

  check-post:
    name: Check post date
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ“ Get latest blog post ğŸ“
        run: |
          BLOG_PATH="content/blog"

          # Find the latest blog post
          latest_post=$(find "${BLOG_PATH}" | grep /index.md$ | grep -v "XX-XX" |sort | tail -n1)
          echo "POST_PATH=${latest_post}" >> $GITHUB_ENV


          # extract date
          date=$(grep "^date:" "${latest_post}" | sed 's/^date: //' | sed 's/["'\'']//g')
          echo "POST_DATE=${date}" >> $GITHUB_ENV

      - name: Check post date
        run: |
          post_date=$(date -d "${{ env.POST_DATE }}" +%Y%m%d)
          two_days_ago=$(date -d "-2 days" +%Y%m%d)
          if (( post_date > two_days_ago )); then
            echo "Post date is within the last 2 days"
            echo "TOOT=true" >> $GITHUB_ENV
          else
            echo "Post date is older than 2 days"
            echo "TOOT=false" >> $GITHUB_ENV
          fi

  announce:
    name: Announce new blog post
    runs-on: ubuntu-latest
    needs: check-post
    if: ${{ needs.check-post.outputs.TOOT == 'true' }}
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get curl and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Get yaml information
        env:
          latest_post: ${{ env.POST_PATH }}
        run: |
          # Extract the URL from the slug
          slug=$(grep "^slug:" "${latest_post}" | sed 's/^slug: //' | sed 's/["'\'']//g')
          url="https://drmowinckels.io/blog/${slug}"
          echo "URL=${url}" >> $GITHUB_ENV

          # Extract image
          image=$(grep "^image:" "${latest_post}" | sed 's/^image: //' | sed 's/["'\'']//g')
          image=$(dirname ${latest_post})/${image}
          echo "IMAGE=${image}" >> $GITHUB_ENV

          # Extract the title from yaml
          title=$(grep "^title:" "${latest_post}" | sed 's/^title: //' | sed 's/["'\'']//g')
          echo "TITLE=${title}" >> $GITHUB_ENV

          # Extract summary using yml
          summary=$(awk '/summary:/ {getline; while ($0 !~ /^$/) {gsub(/^[[:blank:]]+/,"",$0); summary = summary $0 " "; getline}} END {gsub(/[[:blank:]]+$/,"",summary); print summary}' "${latest_post}")
          echo "SUMMARY=${summary}" >> $GITHUB_ENV

          # Extract tags
          tags=$(awk '/tags:/ {getline; while ($0 ~ /^  - /) {printf "#%s ", $2; getline}}' ${latest_post})
          hastags=$(echo $tags| sed -e 's/#r /#rstats /')
          echo "TAGS=${hastags}" >> $GITHUB_ENV

      - name: ğŸ¦¹ Insert random fun emoji ğŸ¦²
        run: |
          emojis=("ğŸ¦„" "ğŸ¦œ" "ğŸ¦£" "ğŸ¦¥" "ğŸ¦¦" "ğŸ¦§" "ğŸ¦¨" "ğŸ¦©" "ğŸ¦ª" \
              "ğŸ¦«" "ğŸ¦¬" "ğŸ¦­" "ğŸ¦®" "ğŸ¦¯" "ğŸ¦°" "ğŸ¦±" "ğŸ¦²" "ğŸ¦³" "ğŸ¦´" \
              "ğŸ¦µ" "ğŸ¦¶" "ğŸ¦·" "ğŸ¦¸" "ğŸ¦¹" "ğŸ¦º" "ğŸ¦»" "ğŸ¦¼" "ğŸ¦½" "ğŸ¦¾" \
              "ğŸ¦¿" "ğŸ§€" "ğŸ§" "ğŸ§‚" "ğŸ§ƒ" "ğŸ§„" "ğŸ§…" "ğŸ§†" "ğŸ§‡" "ğŸ§ˆ" \
              "ğŸ§‰" "ğŸ§Š" "ğŸ§‹" "ğŸ§Œ" "ğŸ§" "ğŸ§" "ğŸ§" "ğŸ§" "ğŸ§‘" "ğŸ§’" \
              "ğŸ§“" "ğŸ§”" "ğŸ§•" "ğŸ§–" "ğŸ§—" "ğŸ§˜" "ğŸ§™" "ğŸ§š" "ğŸ§›" "ğŸ§œ" \
              "ğŸ§" "ğŸ§" "ğŸ§Ÿ" "ğŸ§ " "ğŸ§¡" "ğŸ§¢" "ğŸ§£" "ğŸ§¤" "ğŸ§¥" "ğŸ§¦" \
              "ğŸ§§" "ğŸ§¨" "ğŸ§©" "ğŸ§ª" "ğŸ§«" "ğŸ§¬" "ğŸ§­" "ğŸ§®" "ğŸ§¯" "ğŸ§°" \
              "ğŸ§±" "ğŸ§²" "ğŸ§³" "ğŸ§´" "ğŸ§µ" "ğŸ§¶" "ğŸ§·" "ğŸ§¸" "ğŸ§¹" "ğŸ§º" \
              "ğŸ§»" "ğŸ§¼" "ğŸ§½" "ğŸ§¾" "ğŸ§¿")
          random_emoji=${emojis[$RANDOM % ${#emojis[@]}]}
          echo "EMOJI=${random_emoji}" >> $GITHUB_ENV

      - name: ğŸ¦£ Toot it! ğŸ¦£
          message=$(echo -e "ğŸ“ New blog post ğŸ“
            \n '${{ env.TITLE }}' \
            \n\n ${{ env.EMOJI }}  ${{ env.SUMMARY }} \
            \n\n ğŸ‘€  Read more at ${{ env.URL }} \
            \n\n ${{ env.TAGS }}")

          # Then, create a new status with the media attached
          toot=$(curl -X POST \
            -H "Authorization: Bearer ${MASTO_KEY}" \
            -F "status=${message}" \
            -F "media_ids[]=${MEDIA_ID}" \
            https://${MASTODON_INSTANCE}/api/v1/statuses | jq -r '.id')

          # Display clickable url
          echo "ğŸ¦£ Tooted! ğŸ¦£"
          echo "https://${MASTODON_INSTANCE}/web/statuses/${toot}"

