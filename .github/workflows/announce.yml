on: [workflow_dispatch]


name: Announce on social media

jobs:
  announce:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      RENV_PROFILE: social_media
    steps:
      - uses: actions/checkout@v4
      - name: Get curl and jq and yq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl yq

      - name: 📝 Get latest blog post 📝
        run: |
          BLOG_PATH="content/blog"

          # Find the latest blog post
          latest_post=$(find -f "${BLOG_PATH}" | grep /index.md$ | grep -v "XX-XX" | sort | tail -n1)

          # extract yaml
          post_yaml=$( sed -n '/^---$/,/^---$/p' ${latest_post} | sed '1d;$d')

          # extract date
          echo "POST_DATE=${echo $post_yaml| yq '.date'}" >> $GITHUB_ENV

          # Extract the URL from the slug
          slug=$(printf '%s/%s' \
            $(echo $latest_post | cut -d/ -f3) \
            $(echo $post_yaml| yq '.slug')
          )
          url="https://drmowinckels.io/blog/${slug}"
          echo "URL=${url}" >> $GITHUB_ENV

          # Extract image
          image=$(printf '%s/%s' \
            $(dirname $latest_post) \
            $(echo $post_yaml| yq '.image')
          )
          echo "IMAGE=${image}" >> $GITHUB_ENV

          # Extract the title from yaml
          title=$(echo $post_yaml| yq '.title')
          echo "TITLE=${title}" >> $GITHUB_ENV

          # Extract summary using yml
          summary=$(echo $post_yaml| yq '.summary')
          echo "SUMMARY=${summary}" >> $GITHUB_ENV

          # Extract tags
          tags=$(echo $post_yaml | yq -o=json '.tags' | jq -r '.[] | "#"+.')
          hastags=$(echo "$tags" | tr '\n' ' ' | sed 's/ $//')

          # Insert random fun emoji
          emojis=("🦄" "🦜" "🦣" "🦥" "🦦" "🦧" "🦨" "🦩" "🦪" \
              "🦫" "🦬" "🦭" "🦮" "🦯" "🦰" "🦱" "🦲" "🦳" "🦴" \
              "🦵" "🦶" "🦷" "🦸" "🦹" "🦺" "🦻" "🦼" "🦽" "🦾" \
              "🦿" "🧀" "🧁" "🧂" "🧃" "🧄" "🧅" "🧆" "🧇" "🧈" \
              "🧉" "🧊" "🧋" "🧌" "🧍" "🧎" "🧏" "🧐" "🧑" "🧒" \
              "🧓" "🧔" "🧕" "🧖" "🧗" "🧘" "🧙" "🧚" "🧛" "🧜" \
              "🧝" "🧞" "🧟" "🧠" "🧡" "🧢" "🧣" "🧤" "🧥" "🧦" \
              "🧧" "🧨" "🧩" "🧪" "🧫" "🧬" "🧭" "🧮" "🧯" "🧰" \
              "🧱" "🧲" "🧳" "🧴" "🧵" "🧶" "🧷" "🧸" "🧹" "🧺" \
              "🧻" "🧼" "🧽" "🧾" "🧿")
          random_emoji=${emojis[$RANDOM % ${#emojis[@]}]}

          # Compose message
          message="📝 New blog post 📝
            \n\n '${title}' \
            \n\n ${random_emoji}  ${summary} \
            \n\n 👀  Read more at ${url} \
            \n\n ${hastags}"
          echo "MESSAGE=${message}" >> $GITHUB_ENV


      - name: 🦣 Toot it! 🦣
        if: ${{ env.POST_DATE }} > (date -d "-2 days" +%Y-%m-%d)
        env:
          MASTODON_INSTANCE: fosstodon.org
        run:  |
          # First, upload the media and get the media ID
          MEDIA_ID=$(curl -X POST \
            -H "Authorization: Bearer ${{ secrets.MASTO_KEY }}" \
            -F "file=@./${{ env.IMAGE }}" \
            https://${MASTODON_INSTANCE}/api/v1/media | jq -r '.id')

          # Then, create a new status with the media attached
          toot=$(curl -X POST \
            -H "Authorization: Bearer ${{ secrets.MASTO_KEY }}" \
            -F "status=${{ env.MESSAGE }}" \
            -F "media_ids[]=${MEDIA_ID}" \
            https://${MASTODON_INSTANCE}/api/v1/statuses | jq -r '.id')

          # Display clickable url
          echo "🦣 Tooted! 🦣"
          echo "https://${MASTODON_INSTANCE}/web/statuses/${toot}"

      - name: 🦋 Skeet it 🦋
        if: ${{ env.POST_DATE }} > (date -d "-2 days" +%Y-%m-%d)
        env:
          image: ${{ env.IMAGE }}
          handle: "drmowinckels.bsky.social"
        run: |
          auth_resp=$(curl \
            -H 'Content-Type: application/json' \
            -d '{
              "identifier": "'${handle}'", 
              "password": "'${{ secrets.BLUESKY_PWD }}'"
            }' \
            https://bsky.social/xrpc/com.atproto.server.createSession)

          # Create post details
          ACCESS_JWT=$(echo $auth_resp | jq '.accessJwt'| tr -d '"' )
          DID=$(echo $auth_resp | jq '.did' | tr -d '"' )
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Upload image
          image_resp=$(curl \
            -H "Authorization: Bearer ${ACCESS_JWT}" \
            -H "Content-Type: image/${image##*.}" \
            --data-binary @./${image} \
            https://bsky.social/xrpc/com.atproto.repo.uploadBlob
          )
          image_blob=$(echo $image_resp | jq '.blob' )

          # Post it
          post_resp=$(curl  \
            https://bsky.social/xrpc/com.atproto.repo.createRecord \
            -H "Authorization: Bearer ${ACCESS_JWT}" \
            -H 'Content-Type: application/json' \
            -d '{
              "repo": "'${DID}'",
              "collection": "app.bsky.feed.post", 
              "record": {
                "$type": "app.bsky.feed.post",
                "text": "'${{ env.MESSAGE }}'", 
                "createdAt": "'${DATE}'",
                "embed": {
                  "$type": "app.bsky.embed.images",
                  "images": [{
                    "image": '${image_blob}',
                    "alt": "Featured image of the blogpost"
                  }]
                }
              }
            }'
          )
          bid=$(echo $post_resp | jq '.uri' | cut -d/ -f5 | tr -d '"' )

          # Display clickable url
          echo "🦋 Skeet it! 🦋"
          echo "https://bsky.app/profile/${${handle}}/post/${bid}"

      - name: 📧 Mail it 📧
        run: |
          content=$(cat <<EOF
          <h1 style="font-weight:bold;font-style:normal;font-size:1em;margin:0;font-size:2em;font-weight:normal;font-family:Georgia,Times,'Times New Roman',serif;color:#023f3c;line-height:1.5">${{ env.TITLE }}</h1>

          <table width="100%" border="0" cellspacing="0" cellpadding="0" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;text-align:center;table-layout:fixed;float:none" class="email-image"><tbody><tr><td align="center" style="vertical-align:top"><figure style="margin:1em 0;margin-top:12px;margin-bottom:12px;margin-left:0;margin-right:0;max-width:800px;width:100%"><div style="display:block"><img src="${{ env.URL }}/${{ env.IMAGE }}" width="800" height="auto" style="border:0 none;display:block;height:auto;line-height:100%;outline:none;-webkit-text-decoration:none;text-decoration:none;max-width:100%;border-radius:4px 4px 4px 4px;width:800px;height:auto;object-fit:contain"></div>
          <figcaption style="margin-top:0.4em;font-size:0.8em;text-align:center;display:none">​</figcaption></figure></td></tr></tbody></table>

          <p class="" style="margin:1em 0;font-size:18px;line-height:1.5em;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen-Sans,Ubuntu,Cantarell,'Helvetica Neue',sans-serif;color:#0c4848;font-size:16px;line-height:1.5">${{ env.SUMMARY }}</p>

          <table cellpadding="0" cellspacing="0" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;width:100%;margin:0 auto"><tbody><tr><td style="vertical-align:top">

          <!--[if !mso]>--><table width="100%" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt"><tbody><tr><td align="center" style="vertical-align:top"><a class="email-button" target="_blank" rel="noopener noreferrer" style="color:#0875c1;color:#825a83;margin-bottom:0.5em;border:0 none;font-size:16px;line-height:1.5;background-color:#0f6261;color:#ffffff;border-radius:24px;border-color:#0f6261;background-color:#0f6261;box-sizing:border-box;border-style:solid;color:#ffffff;display:inline-block;text-align:center;text-decoration:none;padding:12px 20px;margin-top:8px;margin-bottom:8px;font-size:16px;border-radius:4px 4px 4px 4px" href="${{ env.URL }}">Read about it</a></td></tr></tbody></table>
          <!--<![endif]--><!--[if mso]><table class="button-table" width="100%" border="0" cellSpacing="0" cellPadding="0" style="margin-top:8px;margin-bottom:8px"><tr><td align="center"><table border="0" cellSpacing="0" cellPadding="0"><tr><td align="center" bgcolor="#0f6261" style="background-color:#0f6261;overflow:hidden;padding:12px 20px"><a class="email-button" target="_blank" rel="noopener noreferrer" style="background-color:inherit;display:inline-block;text-decoration:none;border-style:solid;margin:0;color:#ffffff;font-size:16px" data-ck-element="button">Read about it</a></td></tr></table></td></tr></table><![endif]--><p class="" style="margin:1em 0;font-size:18px;line-height:1.5em;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen-Sans,Ubuntu,Cantarell,'Helvetica Neue',sans-serif;color:#0c4848;font-size:16px;line-height:1.5">​</p>
          </td></tr></tbody></table>
          EOF
          )

          # Escape special characters for JSON using jq
          escaped_content=$(echo "$content" | jq -aRs . | sed 's/^"\(.*\)"$/\1/')

          curl \
            https://api.convertkit.com/v3/broadcasts \
            -H 'Content-Type: application/json' \
            -d '{ 
                "public": false,
                "api_secret": "'${{ secrets.KIT_SECRET }}'",
                "description": "'${summary}'",
                "thumbnail_url": "'${{ env.URL }}/${{ env.IMAGE }}'",
                "subject": "'${title}'",
                "content": "'${escaped_content}'" 
            }'
