<!DOCTYPE html>
<html lang="">
    <head>
        
            <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">

<title>
Using Freesurfer Annotation Files to Plot in R - Dr. Mowinckel&rsquo;s
</title>



            <meta property="og:title" content="Using Freesurfer annotation files to plot in R - Dr. Mowinckel&rsquo;s" />
<meta property="og:type" content="website" />
<meta property="og:description" content=""/>
<meta property="og:url" content="https://drmowinckels.io/blog/2020/using-freesurfer-annotation-files-to-plot-in-r/"/>
<meta property="og:site_name" content="Dr. Mowinckel&rsquo;s"/>



<meta property="og:image" content="https://drmowinckels.io/blog/2020/using-freesurfer-annotation-files-to-plot-in-r/index_files/figure-html/featured-1.png"/>

<meta property="og:image" content="https://drmowinckels.io/blog/2020/using-freesurfer-annotation-files-to-plot-in-r/ply_ss.png"/>



            
<link rel="shortcut icon" href="https://drmowinckels.io/img/fav.ico.png">


            


  
  
  
  <link rel="stylesheet" href="https://drmowinckels.io/css/main.min.8235b6920080e0a7f838f3272dcefed35808d4bd218e9f51f867612e95cab156.css" integrity="sha256-gjW2kgCA4Kf4OPMnLc7&#43;01gI1L0hjp9R&#43;GdhLpXKsVY=" crossorigin="anonymous" media="screen">




    <link rel="stylesheet" href="https://drmowinckels.io/css/syntax.css" integrity="" crossorigin="anonymous" media="screen">
    <link rel="stylesheet" href="https://drmowinckels.io/css/custom-style.css" integrity="" crossorigin="anonymous" media="screen">
        
        
        
        
    </head>
    <body> 
        <section id="top" class="section">
            
            <div class="container hero  fade-in one " style="background-image: url(/img/logo_large.svg);">
                
                

<h1 class="bold-title is-1">Blog</h1>


            </div>
            
            <div class="section  fade-in two ">
                
<div class="container">
    <hr>
    <nav class="navbar" role="navigation" aria-label="main navigation">
        
        <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false" >
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
        <div class="navbar-menu " id="navMenu">
            
            
                
                    
                        <a class="navbar-item" href="https://drmowinckels.io/">
                            
                            Home
                            
                        </a>
                    
                
                    
                        <a class="navbar-item" href="https://drmowinckels.io/about">
                            
                            About
                            
                        </a>
                    
                
                    
                        <a class="navbar-item" href="https://drmowinckels.io/#blog">
                            
                            Blog
                            
                        </a>
                    
                
                    
                        <a class="navbar-item" href="https://drmowinckels.io/#contact">
                            
                            Contact
                            
                        </a>
                    
                
            
        </div>
    </nav>
    <hr>
</div>



                
<div class="container">
    <h2 class="title is-1 top-pad strong-post-title">
        <a href="https://drmowinckels.io/blog/2020/using-freesurfer-annotation-files-to-plot-in-r/">Using Freesurfer annotation files to plot in R</a>
    </h2>
    <div class="post-data">
        Apr 30, 2020 |
        10 minutes read
    </div>
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
      
     <p>
         Tags:
          
           <a href="https://drmowinckels.io/tags/r">
             R</a>,
         
           <a href="https://drmowinckels.io/tags/neuroimaging">
             Neuroimaging</a>,
         
           <a href="https://drmowinckels.io/tags/plots">
             Plots</a>
         
        </p>
      
    
      
    

    
</div>

<div class="container markdown top-pad">
    <p>When you work with neuroimaging data like I do, you often find your self swapping back and forth between R and the imaging software of your choise.
For me, that is usually <a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/">FSL</a> or <a href="https://surfer.nmr.mgh.harvard.edu/">Freesurfer</a>.
Since the resolution of the brain we have is quite large and 3 dimensional, we often reduce the data to segments that meaningfully go together.
For instance, areas of the brain that control language or visual processing, or areas of the brain with similar structural properties.
If you have worked with Freesurfer, the Desikan Killany coortical atlas (aparc) is likely well known to you.
This is an atlas that consist of 36 segments, which are well-defined (<a href="https://surfer.nmr.mgh.harvard.edu/ftp/articles/fischl04-parcellation.pdf">Automatically Parcellating the Human Cerebral Cortex</a>, Fischl et al., (2004). Cerebral Cortex, 14:11-22.)</p>
<p><img src="https://surfer.nmr.mgh.harvard.edu/fswiki/CorticalParcellation?action=AttachFile&amp;do=get&amp;target=annot-desikan.jpg" alt=""><!-- --><img src="https://surfer.nmr.mgh.harvard.edu/fswiki/CorticalParcellation?action=AttachFile&amp;do=get&amp;target=annot-desikan-m.jpg" alt=""><!-- --></p>
<p>Since the brain is full of sulci (grooves), we often inflate the brain surface so we can more clearly see the entire brain.
This is what is shown  above.
For those who have followed some of my posts, you might recognise this image to be similar to the default image from our <a href="https://lcbc-uio.github.io/ggseg/">ggseg</a> package.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">ggseg</span><span class="p">)</span>
</code></pre></div><pre tabindex="0"><code>## Loading required package: ggplot2
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="nf">ggseg</span><span class="p">(</span><span class="n">atlas</span> <span class="o">=</span> <span class="n">dk</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">=</span> <span class="nf">aes</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">region</span><span class="p">),</span>
      <span class="n">position</span> <span class="o">=</span> <span class="s">&#34;stacked&#34;</span><span class="p">,</span> <span class="n">colour</span> <span class="o">=</span> <span class="s">&#34;black&#34;</span><span class="p">,</span> 
      <span class="n">show.legend</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span> <span class="o">+</span> 
  <span class="nf">scale_fill_brain</span><span class="p">(</span><span class="s">&#34;dk&#34;</span><span class="p">)</span>
</code></pre></div><p><img src="index_files/figure-html/featured-1.png" alt=""><!-- --></p>
<p>Similarly is our package <code>ggseg3d</code>, where you can render the proper 3d version using plotly.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">,</span> <span class="n">warn.conflicts</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ggseg3d</span><span class="p">)</span>
<span class="n">p</span> <span class="o">&lt;-</span> <span class="nf">ggseg3d</span><span class="p">(</span><span class="n">atlas</span> <span class="o">=</span> <span class="n">dk_3d</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  <span class="nf">pan_camera</span><span class="p">(</span><span class="n">camera</span> <span class="o">=</span> <span class="s">&#34;right lateral&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span> 
  <span class="nf">remove_axes</span><span class="p">()</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="n">p</span>
</code></pre></div><!--html_preserve--><iframe src="ggseg_1_widget.html" width="100%" height="500px"></iframe><!--/html_preserve-->
<p>That is some nerdy fun!</p>
<p>But getting to the point of having this data was quite some road.
And I&rsquo;d like to share that road with you now.
This entire pipeline is made into a function in our companion package <a href="https://lcbc-uio.github.io/ggsegExtra/">ggsegExtra</a>, the <code>aparc_2_mesh()</code> function.</p>

<h1 id="making-freesurfer-files-into-plotly-mesh-files" class="anchor-link"><a href="#making-freesurfer-files-into-plotly-mesh-files">Making Freesurfer files into plotly mesh files.</a></h1>
<p>First step in this journey, was to take a binary file type that exists in Freesurfer called an annotation file (<code>annot</code>).
The <code>annot</code> file contains information about the segments of the atlas, their colours etc.
I had never worked with binary files before, and if is was not for the fact that I had some early PhD days where I did do some Matlab scripting, I&rsquo;d likely not get any further.
Luckily, I was able to decompose Freesurfer&rsquo;s own matlab script reading this binary file, and translate it into R.
The result can be seen <a href="https://github.com/muschellij2/freesurfer/blob/master/R/read_annotation.R">here</a> in the R package <a href="https://github.com/muschellij2/freesurfer">freesurfer</a> by <a href="https://github.com/muschellij2">John Muschelli</a>.
This was the first time I contributed a real piece of code to another persons package, and John has graciously added me to the list of authors for it.
This makes me quite stoked!</p>
<p>The function resturns a list of three things:</p>
<ol>
<li>a vector of vertices</li>
<li>a vector of labels</li>
<li>a data.frame of colours and region names</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="c1"># remotes::install_github(&#34;muschellij2/freesurfer&#34;)</span>
<span class="n">annot_file</span> <span class="o">&lt;-</span> <span class="s">&#34;/Applications/freesurfer/subjects/fsaverage5/label/lh.aparc.annot&#34;</span>
<span class="n">dk_annot</span> <span class="o">&lt;-</span> <span class="n">freesurfer</span><span class="o">::</span><span class="nf">read_annotation</span><span class="p">(</span><span class="n">annot_file</span><span class="p">)</span>
</code></pre></div><pre tabindex="0"><code>## Reading from version 2 
## colortable with 36 entries read (originally /autofs/space/amaebi_026/users/buckner_cortical_atlas/scripts/colortable_final.txt )
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="nf">str</span><span class="p">(</span><span class="n">dk_annot</span><span class="p">)</span>
</code></pre></div><pre tabindex="0"><code>## List of 3
##  $ vertices  : int [1:10242] 0 1 2 3 4 5 6 7 8 9 ...
##  $ label     : int [1:10242] 14423100 9221140 10542100 8204875 14423100 1351760 9182740 11832480 1639705 3296035 ...
##  $ colortable:'data.frame':	36 obs. of  6 variables:
##   ..$ label: chr [1:36] &quot;unknown&quot; &quot;bankssts&quot; &quot;caudalanteriorcingulate&quot; &quot;caudalmiddlefrontal&quot; ...
##   ..$ R    : int [1:36] 25 25 125 100 120 220 220 180 220 180 ...
##   ..$ G    : int [1:36] 5 100 100 25 70 20 20 220 60 40 ...
##   ..$ B    : int [1:36] 25 40 160 0 50 100 10 140 220 120 ...
##   ..$ A    : int [1:36] 0 0 0 0 0 0 0 0 0 0 ...
##   ..$ code : num [1:36] 1639705 2647065 10511485 6500 3294840 ...
</code></pre><p>This data we will need to create brain segments per row in the data.frame returned.
Since R is more happy with hexidecimal colour codes, we can go ahead and turn RGB to hex</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="n">dk_annot</span><span class="o">$</span><span class="n">colortable</span> <span class="o">&lt;-</span> <span class="nf">mutate</span><span class="p">(</span><span class="n">dk_annot</span><span class="o">$</span><span class="n">colortable</span><span class="p">,</span>
                     <span class="n">hex</span> <span class="o">=</span> <span class="n">grDevices</span><span class="o">::</span><span class="nf">rgb</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> 
                                          <span class="n">maxColorValue</span> <span class="o">=</span> <span class="m">255</span><span class="p">)</span>
<span class="p">)</span>

<span class="nf">as_tibble</span><span class="p">(</span><span class="n">dk_annot</span><span class="o">$</span><span class="n">colortable</span><span class="p">)</span> 
</code></pre></div><pre tabindex="0"><code>## # A tibble: 36 x 7
##    label                       R     G     B     A     code hex    
##    &lt;chr&gt;                   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;dbl&gt; &lt;chr&gt;  
##  1 unknown                    25     5    25     0  1639705 #190519
##  2 bankssts                   25   100    40     0  2647065 #196428
##  3 caudalanteriorcingulate   125   100   160     0 10511485 #7D64A0
##  4 caudalmiddlefrontal       100    25     0     0     6500 #641900
##  5 corpuscallosum            120    70    50     0  3294840 #784632
##  6 cuneus                    220    20   100     0  6558940 #DC1464
##  7 entorhinal                220    20    10     0   660700 #DC140A
##  8 fusiform                  180   220   140     0  9231540 #B4DC8C
##  9 inferiorparietal          220    60   220     0 14433500 #DC3CDC
## 10 inferiortemporal          180    40   120     0  7874740 #B42878
## # … with 26 more rows
</code></pre><p>Next step is to convert the annotation file to what <a href="https://brainder.org/">Anderson Winkler</a> so astoutly has called <code>data-per-vertex</code> file, or a <code>dpv</code> for short.
This is technically an <code>ascii</code> file.
This is what we will use to combine all vertices into triangular meshes for 3d rendering.
For this I made a function called <code>ggsegExtra::annot2dpv</code> for simplicity.
What is does is map the labels from the annotation file, restructure the labels  so that we get a matrix with 5 columns.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="c1"># remotes::install_github(&#34;LCBC-UiO/ggsegExtra&#34;)</span>
<span class="n">dpv</span> <span class="o">&lt;-</span> <span class="n">ggsegExtra</span><span class="o">::</span><span class="nf">annot2dpv</span><span class="p">(</span><span class="n">annot_file</span><span class="p">,</span> <span class="s">&#34;annot.dpv&#34;</span><span class="p">)</span>
</code></pre></div><pre tabindex="0"><code>## Reading from version 2 
## colortable with 36 entries read (originally /autofs/space/amaebi_026/users/buckner_cortical_atlas/scripts/colortable_final.txt )
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="nf">as_tibble</span><span class="p">(</span><span class="n">dpv</span><span class="p">)</span>
</code></pre></div><pre tabindex="0"><code>## # A tibble: 10,242 x 5
##       V1    V2    V3    V4    V5
##    &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
##  1     0     0     0     0    25
##  2     1     0     0     0    30
##  3     2     0     0     0    29
##  4     3     0     0     0    28
##  5     4     0     0     0    25
##  6     5     0     0     0    32
##  7     6     0     0     0    12
##  8     7     0     0     0    26
##  9     8     0     0     0     1
## 10     9     0     0     0    13
## # … with 10,232 more rows
</code></pre><p>This file is the basis for the triangular mesh we will soon make.
The format tok me a while to understand, but it has two main parts:</p>
<ol>
<li>is X number of rows with information of the <em>face</em> of the triangle (i.e. the surface area between three points)</li>
<li>is Y number of rows with information about the <em>vertices</em> for the triangles (i.e. the three connecting dots)</li>
</ol>
<p>Now that we have mapping of vertices and faces, we also need a surface to project on to.
In Freesurfer, we have quite some surfaces to choose from, but we will go with inflated for now, and use the left hemisphere (<code>lh</code>).
This file we also need to convert into an ascii file, with the convenient <code>surf3asc()</code> function we made.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="n">surf_file</span> <span class="o">&lt;-</span> <span class="s">&#34;/Applications/freesurfer/subjects/fsaverage5/surf/lh.inflated&#34;</span>
<span class="n">surf</span> <span class="o">&lt;-</span> <span class="n">ggsegExtra</span><span class="o">::</span><span class="nf">surf2asc</span><span class="p">(</span><span class="n">surf_file</span><span class="p">,</span> <span class="s">&#34;~/Desktop/surf.dpv&#34;</span><span class="p">)</span>
</code></pre></div><pre tabindex="0"><code>## Saving ~/Desktop/surf.dpv
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="nf">str</span><span class="p">(</span><span class="n">surf</span><span class="p">)</span>
</code></pre></div><pre tabindex="0"><code>## List of 2
##  $ vertices:'data.frame':	10242 obs. of  4 variables:
##   ..$ V1: num [1:10242] -5.84 16.43 30.06 5.29 -36.14 ...
##   ..$ V2: num [1:10242] 2.5 -64.2 16.6 92.2 24.7 ...
##   ..$ V3: num [1:10242] 57.65 54.94 43.2 13.27 -2.76 ...
##   ..$ V4: int [1:10242] 0 0 0 0 0 0 0 0 0 0 ...
##  $ faces   :'data.frame':	10239 obs. of  4 variables:
##   ..$ V1: num [1:10239] -5.19 -4.16 -3.1 -2.28 -1.44 ...
##   ..$ V2: num [1:10239] -12.2 -11.7 -11.1 -13.7 -16.3 ...
##   ..$ V3: num [1:10239] -60.7 -60.1 -59.4 -57.5 -55.6 ...
##   ..$ V4: int [1:10239] 0 0 0 0 0 0 0 0 0 0 ...
</code></pre><p>This format we will turn into Stanford Polygon files (<code>.ply</code>) which are quite common for mesh data.
You can read more about this format in Anderson Winklers <a href="https://brainder.org/tag/ply/">blogpost</a>.</p>
<p>This is quite an easy transformation, as it&rsquo;s actually just chaging the text in the ascii  little, but a function always makes transformations easier!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="n">ply</span> <span class="o">&lt;-</span> <span class="n">ggsegExtra</span><span class="o">::</span><span class="nf">asc2ply</span><span class="p">(</span><span class="s">&#34;~/Desktop/surf.dpv&#34;</span><span class="p">,</span><span class="s">&#34;~/Desktop/surf.ply&#34;</span><span class="p">)</span>
<span class="nf">str</span><span class="p">(</span><span class="n">ply</span><span class="p">)</span>
</code></pre></div><pre tabindex="0"><code>##  chr [1:30731] &quot;ply&quot; &quot;format ascii 1.0&quot; &quot;element vertex 10242&quot; ...
</code></pre><p>The fun part is that, despite this being a file made completely of text and might seem very niche, Mac&rsquo;s Finder recognises this format as a 3d object and can preview it for you!
Albeit in a strange angle, there it is!</p>
<p><img src="ply_ss.png" alt="screenshot of ply file in Finder"></p>
<p>The next step is to project the colours from the regions we know of, onto the currently white faces of the meshes.
This, is easier said than done.
While I would have loved to do this on a face-by-face way, I have yet to find a way to do so.
The only way I know how to do this next step, and by no means truly understand what is happening, is by scouring through Anderson Winklers <a href="https://github.com/andersonwinkler/areal">areal scripts</a>.
He does seem to have a graps of face-mapping though, so I&rsquo;m preparing to contact him to learn more about it.</p>
<p>This next step, will split the <code>.ply</code> file into several <code>.ply</code> files based on the information in the labels we previously made.
The function <code>surfsplit()</code> is a doozy, and while it works, I can confidently say I dont know why.
It is a piece of magic Anderson made, that I translated to R.
I sat for several days with R and Matlab side by side, carefully making sure I was getting the same output for the functions.
It was fun and gruelling at the same time.
This function is so very specifically tailored to work within the overarching pipeline, that I have not made it an exported function.
It works only internally.</p>
<p>Sorry about that! But it really is such a piece I think not alot of people will find it particularly interesting.</p>
<p>Once all .ply files are generated, all of them are collected in R using a nested data.frame.</p>
<p>Running the entire pipeline, selecting the subject <code>fsaverage5</code>, right hemisphere, on an inflasted surface, for the <code>aparc</code>(Desikan Killany) atlas.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="n">subj</span> <span class="o">&lt;-</span> <span class="s">&#34;fsaverage5&#34;</span>
<span class="n">fs_subj_dir</span> <span class="o">&lt;-</span> <span class="s">&#34;/Applications/freesurfer/subjects/&#34;</span>

<span class="n">dk_atlas</span> <span class="o">&lt;-</span> <span class="n">ggsegExtra</span><span class="o">::</span><span class="nf">aparc_2_mesh</span><span class="p">(</span><span class="n">subject</span> <span class="o">=</span> <span class="n">subj</span><span class="p">,</span>
                                     <span class="n">hemisphere</span> <span class="o">=</span> <span class="s">&#34;rh&#34;</span><span class="p">,</span>
                                     <span class="n">surface</span> <span class="o">=</span> <span class="s">&#34;inflated&#34;</span><span class="p">,</span>
                                     <span class="n">annot</span> <span class="o">=</span> <span class="s">&#34;aparc&#34;</span><span class="p">,</span>
                                     <span class="n">subjects_dir</span> <span class="o">=</span> <span class="n">fs_subj_dir</span><span class="p">,</span>
                                     <span class="n">annot_dir</span> <span class="o">=</span> <span class="nf">file.path</span><span class="p">(</span><span class="n">fs_subj_dir</span><span class="p">,</span> <span class="n">subj</span><span class="p">,</span> <span class="s">&#34;label&#34;</span><span class="p">),</span>
                                     <span class="n">output_dir</span> <span class="o">=</span> <span class="s">&#34;~/Desktop/&#34;</span><span class="p">,</span>
                                     <span class="n">cleanup</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span>
                                     <span class="n">verbose</span> <span class="o">=</span> <span class="kc">FALSE</span> <span class="p">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="n">dk_atlas</span>
</code></pre></div><pre tabindex="0"><code>## # A tibble: 36 x 9
##    atlas surf   hemi  region       colour  mesh     label       roi   annot     
##    &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;        &lt;chr&gt;   &lt;list&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;     
##  1 dk_3d infla… left  &lt;NA&gt;         &lt;NA&gt;    &lt;named … lh_unknown  0001  unknown   
##  2 dk_3d infla… left  bankssts     #196428 &lt;named … lh_bankssts 0002  bankssts  
##  3 dk_3d infla… left  caudal ante… #7D64A0 &lt;named … lh_caudala… 0003  caudalant…
##  4 dk_3d infla… left  caudal midd… #641900 &lt;named … lh_caudalm… 0004  caudalmid…
##  5 dk_3d infla… left  corpus call… #784632 &lt;named … lh_corpusc… 0005  corpuscal…
##  6 dk_3d infla… left  cuneus       #DC1464 &lt;named … lh_cuneus   0006  cuneus    
##  7 dk_3d infla… left  entorhinal   #DC140A &lt;named … lh_entorhi… 0007  entorhinal
##  8 dk_3d infla… left  fusiform     #B4DC8C &lt;named … lh_fusiform 0008  fusiform  
##  9 dk_3d infla… left  inferior pa… #DC3CDC &lt;named … lh_inferio… 0009  inferiorp…
## 10 dk_3d infla… left  inferior te… #B42878 &lt;named … lh_inferio… 0010  inferiort…
## # … with 26 more rows
</code></pre><p>Within the <code>mesh</code> column, are both the vertices and faced needed to make the mesh for plotting.
In a <em>very</em> simplified version, the <code>ggseg3d()</code> function just loops through each segment and adds it as a trace to plotly.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="n">p</span> <span class="o">=</span> <span class="n">plotly</span><span class="o">::</span><span class="nf">plot_ly</span><span class="p">()</span>
<span class="nf">for </span><span class="p">(</span><span class="n">tt</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="nf">nrow</span><span class="p">(</span><span class="n">dk_atlas</span><span class="p">))</span> <span class="p">{</span>
  
  <span class="n">p</span> <span class="o">=</span> <span class="n">plotly</span><span class="o">::</span><span class="nf">add_trace</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
                        
                        <span class="c1"># map vertices</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">dk_atlas</span><span class="o">$</span><span class="n">mesh[[tt]]</span><span class="o">$</span><span class="n">vertices</span><span class="o">$</span><span class="n">x</span><span class="p">,</span> 
                        <span class="n">y</span> <span class="o">=</span> <span class="n">dk_atlas</span><span class="o">$</span><span class="n">mesh[[tt]]</span><span class="o">$</span><span class="n">vertices</span><span class="o">$</span><span class="n">y</span><span class="p">,</span> 
                        <span class="n">z</span> <span class="o">=</span> <span class="n">dk_atlas</span><span class="o">$</span><span class="n">mesh[[tt]]</span><span class="o">$</span><span class="n">vertices</span><span class="o">$</span><span class="n">z</span><span class="p">,</span> 
                        
                        <span class="c1"># map faces</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">dk_atlas</span><span class="o">$</span><span class="n">mesh[[tt]]</span><span class="o">$</span><span class="n">faces</span><span class="o">$</span><span class="n">i</span> <span class="o">-</span> <span class="m">1</span><span class="p">,</span> 
                        <span class="n">j</span> <span class="o">=</span> <span class="n">dk_atlas</span><span class="o">$</span><span class="n">mesh[[tt]]</span><span class="o">$</span><span class="n">faces</span><span class="o">$</span><span class="n">j</span> <span class="o">-</span> <span class="m">1</span><span class="p">,</span> 
                        <span class="n">k</span> <span class="o">=</span> <span class="n">dk_atlas</span><span class="o">$</span><span class="n">mesh[[tt]]</span><span class="o">$</span><span class="n">faces</span><span class="o">$</span><span class="n">k</span> <span class="o">-</span> <span class="m">1</span><span class="p">,</span> 
                        
                        <span class="n">facecolor</span> <span class="o">=</span> <span class="nf">rep</span><span class="p">(</span><span class="n">dk_atlas</span><span class="o">$</span><span class="n">colour[tt]</span><span class="p">,</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">dk_atlas</span><span class="o">$</span><span class="n">mesh[[tt]]</span><span class="o">$</span><span class="n">faces</span><span class="p">)),</span> 
                        <span class="n">type</span> <span class="o">=</span> <span class="s">&#34;mesh3d&#34;</span><span class="p">,</span> 
                        <span class="n">showscale</span> <span class="o">=</span> <span class="kc">FALSE</span>
                        <span class="p">)</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="n">p</span>
</code></pre></div><!--html_preserve--><iframe src="ggseg_2_widget.html" width="100%" height="500px"></iframe><!--/html_preserve-->
<p>This tok me well over a week to pan out. :)
The translations of Andersons' scripts, the trying desperately to be able to map the faces to colour without splitting up into multiple <code>.ply</code>s.
I learned so much, and it was really a fun challenge!</p>
<p>I hope the function to make the atlas is easy enough for you who need it, and that you will be able to create your own atlases compatible with ggseg3d!</p>


    
    <h3>Citation</h3>
    <div class="columns">
      <div class="column is-half">
        For attribution, please cite this work as
        <div class="highlight" style="border: 1px solid grey">
          <p style="padding: 1em;font-family: 'monospace">
            Dr. Mowinckel (Apr 30, 2020) Using Freesurfer annotation files to plot in R. Retrieved from https://drmowinckels.io/blog/2020/using-freesurfer-annotation-files-to-plot-in-r/
          </p>
        </div>
      </div>
      <div class="column is-half">
        <b>BibTeX citation</b>
        <div class="highlight" style="border: 1px solid grey">
          <p style="padding: 1em;font-family: 'monospace">
            @misc{ 2020-using-freesurfer-annotation-files-to-plot-in-r,<br>
            &emsp;author = { Dr. Mowinckel },<br>
            &emsp;title = { Using Freesurfer annotation files to plot in R },<br>
            &emsp;url = { https://drmowinckels.io/blog/2020/using-freesurfer-annotation-files-to-plot-in-r/ },<br>
            &emsp;year = { 2020 }<br>
            &emsp;updated = { Nov 3, 2023 }<br>
            }
          </p>
        </div>
      </div>
    </div>
  

</div>


<div class="container giscus my-4">
    <script src="https://giscus.app/client.js"
        data-repo=DrMowinckels/DrMowinckels
        data-repo-id=MDEwOlJlcG9zaXRvcnkxMjM0NzEwMTI&#61;
        data-category=Comments
        data-category-id=DIC_kwDOB1wEpM4CAG0c
        data-mapping=pathname
        data-reactions-enabled=1
        data-emit-metadata=0
        data-theme=light
        data-lang=en
        crossorigin="anonymous"
        async>
    </script>
</div>



                
                <div class="container">
    <hr>
</div>
<div class="container has-text-centered top-pad">
    <a href="#top">
        <i class="fa fa-arrow-up"></i>
    </a>
</div>

<div class="container">
    <hr>
</div>

                <div class="section" id="footer">
    <div class="container has-text-centered">
    
        <span class="footer-text">
            Athanasia Monika Mowinckel <i class="fab fa-creative-commons" aria-hidden="true"></i>-<i class="fab fa-creative-commons-by"></i>-<i class="fab fa-creative-commons-sa"></i>-2020. Feeding to <a href="https://rweekly.org'">R weekly</a>. View source code on <a href="https://github.com/Athanasiamo/DrMowinckels"><i class="fab fa-github"></i></a>.
        </span>
    
    </div>
</div>

                
            </div>
        </section>
        
        


<script src="https://drmowinckels.io/js/bundle.f1741e9868b2f697e71cf8fccfcc12166540999b3d36f8fb9edd0882ba425d55.js" integrity="sha256-8XQemGiy9pfnHPj8z8wSFmVAmZs9Nvj7nt0IgrpCXVU=" crossorigin="anonymous">></script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-115545202-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>








  <script defer data-domain=drmowinckels.io src="https://plausible.io/js/plausible.js"></script>






        
        
        
        
    </body>
</html>
