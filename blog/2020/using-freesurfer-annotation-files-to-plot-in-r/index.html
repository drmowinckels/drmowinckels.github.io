<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no"
/>


<title>Using Freesurfer annotation files to plot in R - Dr. Mowinckel&#39;s</title>


<meta name="hugo-igloo" />




  <meta name="description" content="Using Freesurfer, the Desikan Killany coortical atlas (aparc) is an atlas that consist of 36 segments, which are well-defined Automatically Parcellating the Human Cerebral Cortex Using Freisurfer annotation files to plot in R is our package where you can render the proper 3d version using ggplot2 ." />
  <meta name="author" content="Dr. Mowinckel" />






<meta name="generator" content="Hugo 0.119.0">



        

<meta prefix="og: http://ogp.me/ns#" property="og:url" content="https://drmowinckels.io/">
<meta prefix="og: http://ogp.me/ns#" property="og:type" content="website">
<meta prefix="og: http://ogp.me/ns#" property="og:title" content="Using Freesurfer annotation files to plot in R - Dr. Mowinckel&rsquo;s">
<meta prefix="og: http://ogp.me/ns#" property="og:description" content="Using Freesurfer, the Desikan Killany coortical atlas (aparc) is an atlas that consist of 36 segments, which are well-defined Automatically Parcellating the Human Cerebral Cortex Using Freisurfer annotation files to plot in R is our package where you can render the proper 3d version using ggplot2 .">


<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:domain" content="https://drmowinckels.io/">
<meta name="twitter:title" content="Igloo">
<meta name="twitter:description" content="Using Freesurfer, the Desikan Killany coortical atlas (aparc) is an atlas that consist of 36 segments, which are well-defined Automatically Parcellating the Human Cerebral Cortex Using Freisurfer annotation files to plot in R is our package where you can render the proper 3d version using ggplot2 .">



    <meta prefix="og: http://ogp.me/ns#" property="og:image" content="https://drmowinckels.io/blog/2020/using-freesurfer-annotation-files-to-plot-in-r/index_files/figure-html/featured-1.png" />
    <meta name="twitter:image" content="https://drmowinckels.io/blog/2020/using-freesurfer-annotation-files-to-plot-in-r/index_files/figure-html/featured-1.png">



        
  





    



 

    <link rel="stylesheet" href="https://drmowinckels.io/bundle.min.b949f82ef13ab020c09cc9a01a06b5c35de205c6382cde6ed472ebf5efc8e9d2.css" 
    integrity="sha256-uUn4LvE6sCDAnMmgGga1w13iBcY4LN5u1HLr9e/I6dI=" 
    crossorigin="anonymous">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/night-owl.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>



    <script src="https://drmowinckels.io/uikit/dist/js/uikit.min.js"></script>


    <script src="https://drmowinckels.io/uikit/dist/js/uikit-icons.min.js"></script>



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha384-k6Rqe5g0pSv8V0e6fFfFjW1y77vKTjkE1IUaB+MHUO2GtODX6azbMqa6Y53/zJTU" crossorigin="anonymous">

        



    

    
    
    
    <link
        rel="icon"
        href="https://drmowinckels.io/img/fav.ico_hu5c0771520169a7c5939dfeb49415bb9c_5256_16x0_resize_box_3.png"
        sizes="16x16"
        type="image/png"
    />
    
    
    
        
        <link rel="shortcut icon" href="https://drmowinckels.io/favicon.ico" type="image/x-icon">
    
    <link
        rel="icon"
        href="https://drmowinckels.io/img/fav.ico_hu5c0771520169a7c5939dfeb49415bb9c_5256_32x0_resize_box_3.png"
        sizes="32x32"
        type="image/png"
    />
    
    
    
    <link
        rel="icon"
        href="https://drmowinckels.io/img/fav.ico_hu5c0771520169a7c5939dfeb49415bb9c_5256_57x0_resize_box_3.png"
        sizes="57x57"
        type="image/png"
    />
    
    
    
    <link
        rel="icon"
        href="https://drmowinckels.io/img/fav.ico_hu5c0771520169a7c5939dfeb49415bb9c_5256_76x0_resize_box_3.png"
        sizes="76x76"
        type="image/png"
    />
    
    
    
    <link
        rel="icon"
        href="https://drmowinckels.io/img/fav.ico_hu5c0771520169a7c5939dfeb49415bb9c_5256_96x0_resize_box_3.png"
        sizes="96x96"
        type="image/png"
    />
    
    
    
    <link
        rel="icon"
        href="https://drmowinckels.io/img/fav.ico_hu5c0771520169a7c5939dfeb49415bb9c_5256_128x0_resize_box_3.png"
        sizes="128x128"
        type="image/png"
    />
    
    
    
    <link
        rel="apple-touch-icon"
        href="https://drmowinckels.io/img/fav.ico_hu5c0771520169a7c5939dfeb49415bb9c_5256_120x0_resize_box_3.png"
        sizes="120x120"
        type="image/png"
    />
    
    
    
    <link
        rel="icon"
        href="https://drmowinckels.io/img/fav.ico_hu5c0771520169a7c5939dfeb49415bb9c_5256_150x0_resize_box_3.png"
        sizes="150x150"
        type="image/png"
    />
    
    
    
    <link
        rel="apple-touch-icon"
        href="https://drmowinckels.io/img/fav.ico_hu5c0771520169a7c5939dfeb49415bb9c_5256_152x0_resize_box_3.png"
        sizes="152x152"
        type="image/png"
    />
    
    
    
        <meta name="msapplication-TileImage" 
            content="/img/fav.ico_hu5c0771520169a7c5939dfeb49415bb9c_5256_144x0_resize_box_3.png">
    
    <link
        rel="icon"
        href="https://drmowinckels.io/img/fav.ico_hu5c0771520169a7c5939dfeb49415bb9c_5256_144x0_resize_box_3.png"
        sizes="144x144"
        type="image/png"
    />
    
    
    
    <link
        rel="apple-touch-icon"
        href="https://drmowinckels.io/img/fav.ico_hu5c0771520169a7c5939dfeb49415bb9c_5256_180x0_resize_box_3.png"
        sizes="180x180"
        type="image/png"
    />
    
    
    
    <link
        rel="icon"
        href="https://drmowinckels.io/img/fav.ico_hu5c0771520169a7c5939dfeb49415bb9c_5256_192x0_resize_box_3.png"
        sizes="192x192"
        type="image/png"
    />
    
    
    
    <link
        rel="shortcut icon"
        href="https://drmowinckels.io/img/fav.ico_hu5c0771520169a7c5939dfeb49415bb9c_5256_196x0_resize_box_3.png"
        sizes="196x196"
        type="image/png"
    />
<meta name="msapplication-TileColor" content="#198c8c">
<meta name="theme-color" content="#198c8c"> 
<meta name="msapplication-TileColor" content="#198c8c">

    </head>
    <body>
            
<div class="banner ">
    
        <div class="uk-container uk-container-small banner-top">
            <h1>blog</h1>
        </div>
    
</div>

        



<div id="smallnav" uk-offcanvas="flip: true" class="uk-offcanvas">
    <div class="uk-offcanvas-bar">
        <ul class="uk-nav">
            
                <a class="uk-navbar-item uk-logo" href="https://drmowinckels.io/">
                    <img src="https://drmowinckels.io/img/logo.png" width="40">
                </a> 
            
            
                <li>
                    <a href="https://drmowinckels.io/about">
                        About
                        
                    </a>
                    
                </li>
            
                <li>
                    <a href="https://drmowinckels.io/blog">
                        Blog
                        
                    </a>
                    
                </li>
            
                <li>
                    <a href="https://drmowinckels.io/talks">
                        Talks
                        
                    </a>
                    
                </li>
            
                <li>
                    <a href="https://drmowinckels.io/projects">
                        Projects
                        
                    </a>
                    
                </li>
            
        </ul>
    </div>
</div>
<a class="uk-navbar-container uk-navbar-left uk-navbar-toggle uk-hidden@s" uk-toggle="target: #smallnav" uk-navbar-toggle-icon></a>

<div class="uk-visible@s" uk-sticky="sel-target: .uk-navbar-container; cls-active: uk-navbar-sticky">
    <nav class="uk-navbar-container">   
        <div uk-navbar>     
            <div class="uk-navbar-center">
                
                    
                        <div class="uk-navbar-center-left">
                            <ul class="uk-navbar-nav">
                    
                    
                    <li>
                        <a href="https://drmowinckels.io/about">
                            About
                            
                        </a>
                        
                    </li>
                    
                
                    
                    
                    <li>
                        <a href="https://drmowinckels.io/blog">
                            Blog
                            
                        </a>
                        
                    </li>
                    
                            </ul>
                        </div>
                    
                
                    
                    
                        
                            <a class="uk-navbar-item uk-logo" href="https://drmowinckels.io/">
                                <img src="https://drmowinckels.io/img/logo.png" width="40">
                            </a> 
                        
                        <div class="uk-navbar-center-right">
                            <ul class="uk-navbar-nav"> 
                    
                    <li>
                        <a href="https://drmowinckels.io/talks">
                            Talks
                            
                        </a>
                        
                    </li>
                    
                
                    
                    
                    <li>
                        <a href="https://drmowinckels.io/projects">
                            Projects
                            
                        </a>
                        
                    </li>
                    
                            </ul>
                        </div>
                    
                
            </div>
        </div>
    </nav>
</div>


        <div id="content" class="uk-container uk-container-small uk-margin-large-top">
    <article class="uk-article">
        <div class="uk-grid uk-flex-top" uk-grid>
            
            
            <div class="uk-width-1-4@s">
              <img src="https://drmowinckels.io/blog/2020/using-freesurfer-annotation-files-to-plot-in-r/index_files/figure-html/featured-1.png" alt="Using Freesurfer annotation files to plot in R" class="uk-border-rounded">
              
            </div>

        <div class="uk-width-3-4@s">
        <h1 class="uk-article-title">Using Freesurfer annotation files to plot in R</h1>
        
        <div class="uk-border-top uk-article-meta uk-flex uk-flex-center uk-flex-between">
            <h3 class="uk-margin-top-small">
                Apr 30, 2020
            </h3>
            

            
                <div class="uk-flex uk-flex-wrap uk-flex-right">
                    
                        
                        
                        
                        
                        
                        <div class="uk-card uk-margin-left uk-margin-bottom">
                            <a href="https://drmowinckels.io/tags/r/" class="uk-label uk-label-secondary tags" >
                                R
                            </a>
                        </div>
                    
                        
                        
                        
                        
                        
                        <div class="uk-card uk-margin-left uk-margin-bottom">
                            <a href="https://drmowinckels.io/tags/neuroimaging/" class="uk-label uk-label-secondary tags" >
                                Neuroimaging
                            </a>
                        </div>
                    
                        
                        
                        
                        
                        
                        <div class="uk-card uk-margin-left uk-margin-bottom">
                            <a href="https://drmowinckels.io/tags/plots/" class="uk-label uk-label-secondary tags" >
                                Plots
                            </a>
                        </div>
                    
                </div>
            
        </div>
    </div>
        <div id="offcanvas-reveal" uk-offcanvas="mode: reveal; overlay: true">
            <div class="uk-offcanvas-bar">
                <button class="uk-offcanvas-close" type="button" uk-close></button>
                <h3>Table of Content</h3>
                <nav id="TableOfContents"></nav>
            </div>
        </div>
        
            <p class="uk-text-lead">Using Freesurfer, the Desikan Killany coortical atlas (aparc) is an atlas that consist of 36 segments, which are well-defined <a href="https://surfer.mgh.harvard.edu/fswiki/CorticalParcellation?action=AttachFile&amp;do=get&amp;target=annot-desikan-m.jpg">Automatically Parcellating the Human Cerebral Cortex</a> Using Freisurfer annotation files to plot in R is our package where you can render the proper 3d version using ggplot2 .</p>
        
        <div class="uk-markdown uk-width">
            <p>When you work with neuroimaging data like I do, you often find your self swapping back and forth between R and the imaging software of your choise.
For me, that is usually <a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/">FSL</a> or <a href="https://surfer.nmr.mgh.harvard.edu/">Freesurfer</a>.
Since the resolution of the brain we have is quite large and 3 dimensional, we often reduce the data to segments that meaningfully go together.
For instance, areas of the brain that control language or visual processing, or areas of the brain with similar structural properties.
If you have worked with Freesurfer, the Desikan Killany coortical atlas (aparc) is likely well known to you.
This is an atlas that consist of 36 segments, which are well-defined (<a href="https://surfer.nmr.mgh.harvard.edu/ftp/articles/fischl04-parcellation.pdf">Automatically Parcellating the Human Cerebral Cortex</a>, Fischl et al., (2004). Cerebral Cortex, 14:11-22.)</p>
<p><img src="https://surfer.nmr.mgh.harvard.edu/fswiki/CorticalParcellation?action=AttachFile&amp;do=get&amp;target=annot-desikan.jpg" alt=""><!-- --><img src="https://surfer.nmr.mgh.harvard.edu/fswiki/CorticalParcellation?action=AttachFile&amp;do=get&amp;target=annot-desikan-m.jpg" alt=""><!-- --></p>
<p>Since the brain is full of sulci (grooves), we often inflate the brain surface so we can more clearly see the entire brain.
This is what is shown  above.
For those who have followed some of my posts, you might recognise this image to be similar to the default image from our <a href="https://lcbc-uio.github.io/ggseg/">ggseg</a> package.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(ggseg)
</span></span></code></pre></div><pre tabindex="0"><code>## Loading required package: ggplot2
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">ggseg</span>(atlas <span style="color:#f92672">=</span> dk, mapping <span style="color:#f92672">=</span> <span style="color:#a6e22e">aes</span>(fill<span style="color:#f92672">=</span>region),
</span></span><span style="display:flex;"><span>      position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;stacked&#34;</span>, colour <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;black&#34;</span>, 
</span></span><span style="display:flex;"><span>      show.legend <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>) <span style="color:#f92672">+</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">scale_fill_brain</span>(<span style="color:#e6db74">&#34;dk&#34;</span>)
</span></span></code></pre></div><p><img src="index_files/figure-html/featured-1.png" alt=""><!-- --></p>
<p>Similarly is our package <code>ggseg3d</code>, where you can render the proper 3d version using plotly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(dplyr, warn.conflicts <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(ggseg3d)
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ggseg3d</span>(atlas <span style="color:#f92672">=</span> dk_3d) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pan_camera</span>(camera <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;right lateral&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">remove_axes</span>()
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>p
</span></span></code></pre></div><!--html_preserve--><iframe src="ggseg_1_widget.html" width="100%" height="500px"></iframe><!--/html_preserve-->
<p>That is some nerdy fun!</p>
<p>But getting to the point of having this data was quite some road.
And I&rsquo;d like to share that road with you now.
This entire pipeline is made into a function in our companion package <a href="https://lcbc-uio.github.io/ggsegExtra/">ggsegExtra</a>, the <code>aparc_2_mesh()</code> function.</p>
<h1 id="making-freesurfer-files-into-plotly-mesh-files">Making Freesurfer files into plotly mesh files.</h1>
<p>First step in this journey, was to take a binary file type that exists in Freesurfer called an annotation file (<code>annot</code>).
The <code>annot</code> file contains information about the segments of the atlas, their colours etc.
I had never worked with binary files before, and if is was not for the fact that I had some early PhD days where I did do some Matlab scripting, I&rsquo;d likely not get any further.
Luckily, I was able to decompose Freesurfer&rsquo;s own matlab script reading this binary file, and translate it into R.
The result can be seen <a href="https://github.com/muschellij2/freesurfer/blob/master/R/read_annotation.R">here</a> in the R package <a href="https://github.com/muschellij2/freesurfer">freesurfer</a> by <a href="https://github.com/muschellij2">John Muschelli</a>.
This was the first time I contributed a real piece of code to another persons package, and John has graciously added me to the list of authors for it.
This makes me quite stoked!</p>
<p>The function resturns a list of three things:</p>
<ol>
<li>a vector of vertices</li>
<li>a vector of labels</li>
<li>a data.frame of colours and region names</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#75715e"># remotes::install_github(&#34;muschellij2/freesurfer&#34;)</span>
</span></span><span style="display:flex;"><span>annot_file <span style="color:#f92672">&lt;-</span> <span style="color:#e6db74">&#34;/Applications/freesurfer/subjects/fsaverage5/label/lh.aparc.annot&#34;</span>
</span></span><span style="display:flex;"><span>dk_annot <span style="color:#f92672">&lt;-</span> freesurfer<span style="color:#f92672">::</span><span style="color:#a6e22e">read_annotation</span>(annot_file)
</span></span></code></pre></div><pre tabindex="0"><code>## Reading from version 2 
## colortable with 36 entries read (originally /autofs/space/amaebi_026/users/buckner_cortical_atlas/scripts/colortable_final.txt )
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">str</span>(dk_annot)
</span></span></code></pre></div><pre tabindex="0"><code>## List of 3
##  $ vertices  : int [1:10242] 0 1 2 3 4 5 6 7 8 9 ...
##  $ label     : int [1:10242] 14423100 9221140 10542100 8204875 14423100 1351760 9182740 11832480 1639705 3296035 ...
##  $ colortable:&#39;data.frame&#39;:	36 obs. of  6 variables:
##   ..$ label: chr [1:36] &#34;unknown&#34; &#34;bankssts&#34; &#34;caudalanteriorcingulate&#34; &#34;caudalmiddlefrontal&#34; ...
##   ..$ R    : int [1:36] 25 25 125 100 120 220 220 180 220 180 ...
##   ..$ G    : int [1:36] 5 100 100 25 70 20 20 220 60 40 ...
##   ..$ B    : int [1:36] 25 40 160 0 50 100 10 140 220 120 ...
##   ..$ A    : int [1:36] 0 0 0 0 0 0 0 0 0 0 ...
##   ..$ code : num [1:36] 1639705 2647065 10511485 6500 3294840 ...
</code></pre><p>This data we will need to create brain segments per row in the data.frame returned.
Since R is more happy with hexidecimal colour codes, we can go ahead and turn RGB to hex</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>dk_annot<span style="color:#f92672">$</span>colortable <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">mutate</span>(dk_annot<span style="color:#f92672">$</span>colortable,
</span></span><span style="display:flex;"><span>                     hex <span style="color:#f92672">=</span> grDevices<span style="color:#f92672">::</span><span style="color:#a6e22e">rgb</span>(R, G, B, 
</span></span><span style="display:flex;"><span>                                          maxColorValue <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">as_tibble</span>(dk_annot<span style="color:#f92672">$</span>colortable) 
</span></span></code></pre></div><pre tabindex="0"><code>## # A tibble: 36 x 7
##    label                       R     G     B     A     code hex    
##    &lt;chr&gt;                   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;dbl&gt; &lt;chr&gt;  
##  1 unknown                    25     5    25     0  1639705 #190519
##  2 bankssts                   25   100    40     0  2647065 #196428
##  3 caudalanteriorcingulate   125   100   160     0 10511485 #7D64A0
##  4 caudalmiddlefrontal       100    25     0     0     6500 #641900
##  5 corpuscallosum            120    70    50     0  3294840 #784632
##  6 cuneus                    220    20   100     0  6558940 #DC1464
##  7 entorhinal                220    20    10     0   660700 #DC140A
##  8 fusiform                  180   220   140     0  9231540 #B4DC8C
##  9 inferiorparietal          220    60   220     0 14433500 #DC3CDC
## 10 inferiortemporal          180    40   120     0  7874740 #B42878
## # … with 26 more rows
</code></pre><p>Next step is to convert the annotation file to what <a href="https://brainder.org/">Anderson Winkler</a> so astoutly has called <code>data-per-vertex</code> file, or a <code>dpv</code> for short.
This is technically an <code>ascii</code> file.
This is what we will use to combine all vertices into triangular meshes for 3d rendering.
For this I made a function called <code>ggsegExtra::annot2dpv</code> for simplicity.
What is does is map the labels from the annotation file, restructure the labels  so that we get a matrix with 5 columns.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#75715e"># remotes::install_github(&#34;LCBC-UiO/ggsegExtra&#34;)</span>
</span></span><span style="display:flex;"><span>dpv <span style="color:#f92672">&lt;-</span> ggsegExtra<span style="color:#f92672">::</span><span style="color:#a6e22e">annot2dpv</span>(annot_file, <span style="color:#e6db74">&#34;annot.dpv&#34;</span>)
</span></span></code></pre></div><pre tabindex="0"><code>## Reading from version 2 
## colortable with 36 entries read (originally /autofs/space/amaebi_026/users/buckner_cortical_atlas/scripts/colortable_final.txt )
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">as_tibble</span>(dpv)
</span></span></code></pre></div><pre tabindex="0"><code>## # A tibble: 10,242 x 5
##       V1    V2    V3    V4    V5
##    &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
##  1     0     0     0     0    25
##  2     1     0     0     0    30
##  3     2     0     0     0    29
##  4     3     0     0     0    28
##  5     4     0     0     0    25
##  6     5     0     0     0    32
##  7     6     0     0     0    12
##  8     7     0     0     0    26
##  9     8     0     0     0     1
## 10     9     0     0     0    13
## # … with 10,232 more rows
</code></pre><p>This file is the basis for the triangular mesh we will soon make.
The format tok me a while to understand, but it has two main parts:</p>
<ol>
<li>is X number of rows with information of the <em>face</em> of the triangle (i.e. the surface area between three points)</li>
<li>is Y number of rows with information about the <em>vertices</em> for the triangles (i.e. the three connecting dots)</li>
</ol>
<p>Now that we have mapping of vertices and faces, we also need a surface to project on to.
In Freesurfer, we have quite some surfaces to choose from, but we will go with inflated for now, and use the left hemisphere (<code>lh</code>).
This file we also need to convert into an ascii file, with the convenient <code>surf3asc()</code> function we made.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>surf_file <span style="color:#f92672">&lt;-</span> <span style="color:#e6db74">&#34;/Applications/freesurfer/subjects/fsaverage5/surf/lh.inflated&#34;</span>
</span></span><span style="display:flex;"><span>surf <span style="color:#f92672">&lt;-</span> ggsegExtra<span style="color:#f92672">::</span><span style="color:#a6e22e">surf2asc</span>(surf_file, <span style="color:#e6db74">&#34;~/Desktop/surf.dpv&#34;</span>)
</span></span></code></pre></div><pre tabindex="0"><code>## Saving ~/Desktop/surf.dpv
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">str</span>(surf)
</span></span></code></pre></div><pre tabindex="0"><code>## List of 2
##  $ vertices:&#39;data.frame&#39;:	10242 obs. of  4 variables:
##   ..$ V1: num [1:10242] -5.84 16.43 30.06 5.29 -36.14 ...
##   ..$ V2: num [1:10242] 2.5 -64.2 16.6 92.2 24.7 ...
##   ..$ V3: num [1:10242] 57.65 54.94 43.2 13.27 -2.76 ...
##   ..$ V4: int [1:10242] 0 0 0 0 0 0 0 0 0 0 ...
##  $ faces   :&#39;data.frame&#39;:	10239 obs. of  4 variables:
##   ..$ V1: num [1:10239] -5.19 -4.16 -3.1 -2.28 -1.44 ...
##   ..$ V2: num [1:10239] -12.2 -11.7 -11.1 -13.7 -16.3 ...
##   ..$ V3: num [1:10239] -60.7 -60.1 -59.4 -57.5 -55.6 ...
##   ..$ V4: int [1:10239] 0 0 0 0 0 0 0 0 0 0 ...
</code></pre><p>This format we will turn into Stanford Polygon files (<code>.ply</code>) which are quite common for mesh data.
You can read more about this format in Anderson Winklers <a href="https://brainder.org/tag/ply/">blogpost</a>.</p>
<p>This is quite an easy transformation, as it&rsquo;s actually just chaging the text in the ascii  little, but a function always makes transformations easier!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>ply <span style="color:#f92672">&lt;-</span> ggsegExtra<span style="color:#f92672">::</span><span style="color:#a6e22e">asc2ply</span>(<span style="color:#e6db74">&#34;~/Desktop/surf.dpv&#34;</span>,<span style="color:#e6db74">&#34;~/Desktop/surf.ply&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">str</span>(ply)
</span></span></code></pre></div><pre tabindex="0"><code>##  chr [1:30731] &#34;ply&#34; &#34;format ascii 1.0&#34; &#34;element vertex 10242&#34; ...
</code></pre><p>The fun part is that, despite this being a file made completely of text and might seem very niche, Mac&rsquo;s Finder recognises this format as a 3d object and can preview it for you!
Albeit in a strange angle, there it is!</p>
<p><img src="ply_ss.png" alt="screenshot of ply file in Finder"></p>
<p>The next step is to project the colours from the regions we know of, onto the currently white faces of the meshes.
This, is easier said than done.
While I would have loved to do this on a face-by-face way, I have yet to find a way to do so.
The only way I know how to do this next step, and by no means truly understand what is happening, is by scouring through Anderson Winklers <a href="https://github.com/andersonwinkler/areal">areal scripts</a>.
He does seem to have a graps of face-mapping though, so I&rsquo;m preparing to contact him to learn more about it.</p>
<p>This next step, will split the <code>.ply</code> file into several <code>.ply</code> files based on the information in the labels we previously made.
The function <code>surfsplit()</code> is a doozy, and while it works, I can confidently say I dont know why.
It is a piece of magic Anderson made, that I translated to R.
I sat for several days with R and Matlab side by side, carefully making sure I was getting the same output for the functions.
It was fun and gruelling at the same time.
This function is so very specifically tailored to work within the overarching pipeline, that I have not made it an exported function.
It works only internally.</p>
<p>Sorry about that! But it really is such a piece I think not alot of people will find it particularly interesting.</p>
<p>Once all .ply files are generated, all of them are collected in R using a nested data.frame.</p>
<p>Running the entire pipeline, selecting the subject <code>fsaverage5</code>, right hemisphere, on an inflasted surface, for the <code>aparc</code>(Desikan Killany) atlas.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>subj <span style="color:#f92672">&lt;-</span> <span style="color:#e6db74">&#34;fsaverage5&#34;</span>
</span></span><span style="display:flex;"><span>fs_subj_dir <span style="color:#f92672">&lt;-</span> <span style="color:#e6db74">&#34;/Applications/freesurfer/subjects/&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dk_atlas <span style="color:#f92672">&lt;-</span> ggsegExtra<span style="color:#f92672">::</span><span style="color:#a6e22e">aparc_2_mesh</span>(subject <span style="color:#f92672">=</span> subj,
</span></span><span style="display:flex;"><span>                                     hemisphere <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;rh&#34;</span>,
</span></span><span style="display:flex;"><span>                                     surface <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;inflated&#34;</span>,
</span></span><span style="display:flex;"><span>                                     annot <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;aparc&#34;</span>,
</span></span><span style="display:flex;"><span>                                     subjects_dir <span style="color:#f92672">=</span> fs_subj_dir,
</span></span><span style="display:flex;"><span>                                     annot_dir <span style="color:#f92672">=</span> <span style="color:#a6e22e">file.path</span>(fs_subj_dir, subj, <span style="color:#e6db74">&#34;label&#34;</span>),
</span></span><span style="display:flex;"><span>                                     output_dir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;~/Desktop/&#34;</span>,
</span></span><span style="display:flex;"><span>                                     cleanup <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>,
</span></span><span style="display:flex;"><span>                                     verbose <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span> )
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>dk_atlas
</span></span></code></pre></div><pre tabindex="0"><code>## # A tibble: 36 x 9
##    atlas surf   hemi  region       colour  mesh     label       roi   annot     
##    &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;        &lt;chr&gt;   &lt;list&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;     
##  1 dk_3d infla… left  &lt;NA&gt;         &lt;NA&gt;    &lt;named … lh_unknown  0001  unknown   
##  2 dk_3d infla… left  bankssts     #196428 &lt;named … lh_bankssts 0002  bankssts  
##  3 dk_3d infla… left  caudal ante… #7D64A0 &lt;named … lh_caudala… 0003  caudalant…
##  4 dk_3d infla… left  caudal midd… #641900 &lt;named … lh_caudalm… 0004  caudalmid…
##  5 dk_3d infla… left  corpus call… #784632 &lt;named … lh_corpusc… 0005  corpuscal…
##  6 dk_3d infla… left  cuneus       #DC1464 &lt;named … lh_cuneus   0006  cuneus    
##  7 dk_3d infla… left  entorhinal   #DC140A &lt;named … lh_entorhi… 0007  entorhinal
##  8 dk_3d infla… left  fusiform     #B4DC8C &lt;named … lh_fusiform 0008  fusiform  
##  9 dk_3d infla… left  inferior pa… #DC3CDC &lt;named … lh_inferio… 0009  inferiorp…
## 10 dk_3d infla… left  inferior te… #B42878 &lt;named … lh_inferio… 0010  inferiort…
## # … with 26 more rows
</code></pre><p>Within the <code>mesh</code> column, are both the vertices and faced needed to make the mesh for plotting.
In a <em>very</em> simplified version, the <code>ggseg3d()</code> function just loops through each segment and adds it as a trace to plotly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>p <span style="color:#f92672">=</span> plotly<span style="color:#f92672">::</span><span style="color:#a6e22e">plot_ly</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">for </span>(tt in <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#a6e22e">nrow</span>(dk_atlas)) {
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  p <span style="color:#f92672">=</span> plotly<span style="color:#f92672">::</span><span style="color:#a6e22e">add_trace</span>(p,
</span></span><span style="display:flex;"><span>                        
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e"># map vertices</span>
</span></span><span style="display:flex;"><span>                        x <span style="color:#f92672">=</span> dk_atlas<span style="color:#f92672">$</span>mesh[[tt]]<span style="color:#f92672">$</span>vertices<span style="color:#f92672">$</span>x, 
</span></span><span style="display:flex;"><span>                        y <span style="color:#f92672">=</span> dk_atlas<span style="color:#f92672">$</span>mesh[[tt]]<span style="color:#f92672">$</span>vertices<span style="color:#f92672">$</span>y, 
</span></span><span style="display:flex;"><span>                        z <span style="color:#f92672">=</span> dk_atlas<span style="color:#f92672">$</span>mesh[[tt]]<span style="color:#f92672">$</span>vertices<span style="color:#f92672">$</span>z, 
</span></span><span style="display:flex;"><span>                        
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e"># map faces</span>
</span></span><span style="display:flex;"><span>                        i <span style="color:#f92672">=</span> dk_atlas<span style="color:#f92672">$</span>mesh[[tt]]<span style="color:#f92672">$</span>faces<span style="color:#f92672">$</span>i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, 
</span></span><span style="display:flex;"><span>                        j <span style="color:#f92672">=</span> dk_atlas<span style="color:#f92672">$</span>mesh[[tt]]<span style="color:#f92672">$</span>faces<span style="color:#f92672">$</span>j <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, 
</span></span><span style="display:flex;"><span>                        k <span style="color:#f92672">=</span> dk_atlas<span style="color:#f92672">$</span>mesh[[tt]]<span style="color:#f92672">$</span>faces<span style="color:#f92672">$</span>k <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, 
</span></span><span style="display:flex;"><span>                        
</span></span><span style="display:flex;"><span>                        facecolor <span style="color:#f92672">=</span> <span style="color:#a6e22e">rep</span>(dk_atlas<span style="color:#f92672">$</span>colour[tt], <span style="color:#a6e22e">nrow</span>(dk_atlas<span style="color:#f92672">$</span>mesh[[tt]]<span style="color:#f92672">$</span>faces)), 
</span></span><span style="display:flex;"><span>                        type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mesh3d&#34;</span>, 
</span></span><span style="display:flex;"><span>                        showscale <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>
</span></span><span style="display:flex;"><span>                        )
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>p
</span></span></code></pre></div><!--html_preserve--><iframe src="ggseg_2_widget.html" width="100%" height="500px"></iframe><!--/html_preserve-->
<p>This tok me well over a week to pan out. :)
The translations of Andersons&rsquo; scripts, the trying desperately to be able to map the faces to colour without splitting up into multiple <code>.ply</code>s.
I learned so much, and it was really a fun challenge!</p>
<p>I hope the function to make the atlas is easy enough for you who need it, and that you will be able to create your own atlases compatible with ggseg3d!</p>

        </div>
    </article><div class="uk-margin">
    <button  class="uk-button uk-button-default" uk-toggle="target: #citation; animation: uk-animation-fade" type="button">
        Cite me!
    </button>
    <div id="citation" hidden class="uk-margin">
        <div uk-grid class="uk-child-width-1-2@s">
            <div>
                For attribution, please cite this work as
                <div class="uk-card uk-card-default uk-card-bod uk-text-breaky">
                    Dr. Mowinckel 
                    (Apr 30, 2020) 
                    Using Freesurfer annotation files to plot in R. 
                    Retrieved from https://drmowinckels.io/blog/2020/using-freesurfer-annotation-files-to-plot-in-r/.
                     DOI: https://www.doi.org/10.5281/zenodo.13273502
                </div>
            </div>
            <div>
                <b>BibTeX citation</b>
                <div class="uk-card uk-card-default uk-card-body uk-text-break">
                    @misc{ <br>
                        2020-using-freesurfer-annotation-files-to-plot-in-r,<br>
                        &emsp;author =  "Dr. Mowinckel",<br>
                        &emsp;title = "Using Freesurfer annotation files to plot in R",<br>
                        &emsp;url = "https://drmowinckels.io/blog/2020/using-freesurfer-annotation-files-to-plot-in-r/",<br>
                        &emsp;year = 2020,<br>
                         &emsp;doi = "https://www.doi.org/10.5281/zenodo.13273502",<br> 
                        &emsp;updated = "Oct 7, 2024"<br>
                    }
                </div>
            </div>
        </div>
    </div>
</div><div class="uk-grid uk-child-width-expand@s uk-margin-top" uk-grid>
    <div class="uk-width-expand">
        
            <a class="uk-button uk-button-default" href="https://drmowinckels.io/blog/2019/do-you-wanna-build-a-snowman/">
                <span class="uk-margin-small-left" uk-icon="chevron-double-left"></span>
                Do you wanna build a snowman?
            </a>
        
    </div>
    
    <div class="uk-width-auto">
        
            <a class="uk-button uk-button-default" href="https://drmowinckels.io/blog/2020/changing-you-blogdown-workflow/">
                Changing your Blogdown Workflow
                <span class="uk-margin-small-right" uk-icon="chevron-double-right"></span>
            </a>
        
    </div>
</div>

    
    
        <div class="uk-container uk-margin-top">
            <script src="https://giscus.app/client.js"
                data-repo=DrMowinckels/drmowinckels.github.io
                data-repo-id=MDEwOlJlcG9zaXRvcnkxMjM0NzEwMTI&#61;
                data-category=Comments
                data-category-id=DIC_kwDOB1wEpM4CAG0c
                data-mapping=pathname
                data-reactions-enabled=1
                data-emit-metadata=0
                data-theme=light
                data-lang=en
                crossorigin="anonymous"
                async>
            </script>
</div>

    

        </div><div class="section uk-section uk-padding-remove-vertical uk-margin">
    <div class="banner footer" height="500px">
        <div class="uk-container">
            <div class="uk-grid" uk-grid>
                <div class="uk-width-1-2@m">
                    
                      <h3><i class="fa-regular fa-copyright"></i> 2023 Athanasia Mo Mowinckel</h3>
                      <p></p>
                    
                  </div>
              <div class="uk-width-1-2@m">
                
              </div>
            </div>
          </div>
          <div class="footer-title uk-text-right">
            <h1>Dr. Mowinckel&rsquo;s</h1>
        </div>
    </div>
</div>
</body>
</html>
